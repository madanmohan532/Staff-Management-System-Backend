package training.iqgateway.controller;

import java.util.ArrayList;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.dao.DuplicateKeyException;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import training.iqgateway.dto.HospitalRegistrationRequestDTO;
import training.iqgateway.dto.HospitalRegistrationResponseDTO;
import training.iqgateway.entity.HospitalRegistrationEntity;
import training.iqgateway.service.HospitalRegistrationService;
import training.iqgateway.util.HospitalUtils;

@RestController
@CrossOrigin
@RequestMapping("api/registration")
public class RegistrationController {

//	@GetMapping("/hi")
//	public String sayHello() {
//		return "HEllo Bhai";
//	}

	@Autowired
	HospitalRegistrationService hospitalRegistrationService;

//	List<HospitalRegistrationResponseDTO> allHospitalResponseDTO = new ArrayList<>();
//
//	HospitalRegistrationResponseDTO hospitalResponseDTO = new HospitalRegistrationResponseDTO();
//
//	HospitalRegistrationResponseDTO.Address address = new HospitalRegistrationResponseDTO.Address();
//	
//	HospitalRegistrationEntity hospitalEntity = new HospitalRegistrationEntity();
//	
//	HospitalRegistrationRequestDTO hospitalRequestDTO = new HospitalRegistrationRequestDTO();
//
//	HospitalRegistrationResponseDTO.ContactDetails contactDetails = new HospitalRegistrationResponseDTO.ContactDetails();

//	@GetMapping("/hospitals")
//	public List<HospitalRegistrationResponseDTO> getAllHospitals() {
//
//		List<HospitalRegistrationEntity> listOfHospitalEntity = hospitalRegistrationService.findAllHospitals();
//
//		for (HospitalRegistrationEntity hospital : listOfHospitalEntity) {
//
//			hospitalResponseDTO.set_id(hospital.get_id());
//			hospitalResponseDTO.setName(hospital.getName());
//			hospitalResponseDTO.setCeoName(hospital.getCeoName());
//		
//			String city = hospital.getAddress().getCity();
//			String state = hospital.getAddress().getState();
//			String pincode = hospital.getAddress().getPincode();
//			String street = hospital.getAddress().getStreet();
//			address.setCity(city);
//			address.setPincode(pincode);
//			address.setState(state);
//			address.setStreet(street);
//			hospitalResponseDTO.setAddress(address);
//
//			String email = hospital.getContactDetails().getEmail();
//			String phone = hospital.getContactDetails().getPhone();
//
//			contactDetails.setEmail(email);
//			contactDetails.setPhone(phone);
//
//			hospitalResponseDTO.setContactDetails(contactDetails);
//			hospitalResponseDTO.setStaffDetails(hospital.getStaffDetails());
//			hospitalResponseDTO.setRegistrationStatus(hospital.getRegistrationStatus());
//
//			allHospitalResponseDTO.add(hospitalResponseDTO);
//		}
//
//		return allHospitalResponseDTO;
//
//	}
	@GetMapping("/hospitals")
	public List<HospitalRegistrationResponseDTO> getAllHospitals() {
	    List<HospitalRegistrationResponseDTO> allHospitalResponseDTO = new ArrayList<>();

	    List<HospitalRegistrationEntity> listOfHospitalEntity = hospitalRegistrationService.findAllHospitals();

	    for (HospitalRegistrationEntity hospital : listOfHospitalEntity) {
	        HospitalRegistrationResponseDTO hospitalResponseDTO = new HospitalRegistrationResponseDTO();

	        HospitalRegistrationResponseDTO.Address address = new HospitalRegistrationResponseDTO.Address();
	        HospitalRegistrationResponseDTO.ContactDetails contactDetails = new HospitalRegistrationResponseDTO.ContactDetails();

	        hospitalResponseDTO.set_id(hospital.get_id());
	        hospitalResponseDTO.setName(hospital.getName());
	        hospitalResponseDTO.setCeoName(hospital.getCeoName());
	        hospitalResponseDTO.setCertificate(hospital.getCertificate());
	        address.setCity(hospital.getAddress().getCity());
	        address.setPincode(hospital.getAddress().getPincode());
	        address.setState(hospital.getAddress().getState());
	        address.setStreet(hospital.getAddress().getStreet());

	        hospitalResponseDTO.setAddress(address);

	        contactDetails.setEmail(hospital.getContactDetails().getEmail());
	        contactDetails.setPhone(hospital.getContactDetails().getPhone());

	        hospitalResponseDTO.setContactDetails(contactDetails);
	        hospitalResponseDTO.setStaffDetails(hospital.getStaffDetails());
	        hospitalResponseDTO.setRegistrationStatus(hospital.getRegistrationStatus());

	        allHospitalResponseDTO.add(hospitalResponseDTO);
	    }

	    return allHospitalResponseDTO;
	}

	@PostMapping("/hospital")
	public ResponseEntity<?> registerHospital(@RequestBody HospitalRegistrationRequestDTO hospitalRequestDTO) {
		HospitalRegistrationEntity hospitalEntity = new HospitalRegistrationEntity();
		
		
		hospitalEntity.setName(hospitalRequestDTO.getName());
		hospitalEntity.setCeoName(hospitalRequestDTO.getCeoName());
		hospitalEntity.setCertificate(hospitalRequestDTO.getCertificate());
		
		String city = hospitalRequestDTO.getAddress().getCity();
		String street = hospitalRequestDTO.getAddress().getPincode();
		String state = hospitalRequestDTO.getAddress().getState();
		String pincode = hospitalRequestDTO.getAddress().getPincode();
		
		hospitalEntity.setAddress(new HospitalRegistrationEntity.Address(street,city,state,pincode));
		
		hospitalEntity.setContactDetails(new HospitalRegistrationEntity.ContactDetails(
			 hospitalRequestDTO.getContactDetails().getPhone(),hospitalRequestDTO.getContactDetails().getEmail()));
		hospitalEntity.set_id(HospitalUtils.HospitalIdGenerator(hospitalRequestDTO.getContactDetails().getPhone(), pincode));
		hospitalEntity.setStaffDetails(hospitalRequestDTO.getStaffDetails());
		hospitalEntity.setRegistrationStatus(hospitalRequestDTO.getRegistrationStatus());
		
	 HospitalRegistrationEntity registeredHospitalEntity =	null;
	 try {
		 registeredHospitalEntity = hospitalRegistrationService.registerHospital(hospitalEntity);
	 }catch (DuplicateKeyException mwe) {
		// TODO: handle exception
		 System.out.println("inside catch block");
		 return new ResponseEntity<>("Email already exists, want to login ?",HttpStatus.CONFLICT);
	}
		
		return new ResponseEntity<>(HospitalUtils.convertToResponseDTO(registeredHospitalEntity),HttpStatus.ACCEPTED);
	}

}
